---
title: "ã€C#ã€‘ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ãƒ»ã‚½ãƒ¼ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼é–‹ç™ºã®ãƒã‚¤ãƒ³ãƒˆ"
emoji: "ğŸ·"
type: "tech"
topics:
  - "dotnet"
  - "csharp"
  - "ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼"
  - "ã‚½ãƒ¼ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼"
published: true
published_at: "2021-03-21 12:09"
---

https://github.com/naminodarie/ac-library-csharp
https://github.com/naminodarie/SourceExpander

ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ãƒ»ã‚½ãƒ¼ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ã„ãã¤ã‹é–‹ç™ºã—ãŸã®ã§çŸ¥è¦‹ã‚’ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚

C#ä»¥å¤–ã®.NETã®è¨€èªã§ã‚‚åŒæ§˜ã‹ã¨æ€ã„ã¾ã™ãŒã€C#ã§ã®é–‹ç™ºãªã®ã§C#è¨˜äº‹ã¨ã—ã¾ã™ã€‚

è¦‹å‡ºã—ã«[A/S]ã¨ã‚ã‚‹ã®ã¯ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ãƒ»ã‚½ãƒ¼ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼å…±é€šã€[A]ã¯ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã®ã¿ã€[S]ã¯ã‚½ãƒ¼ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã¿ã‚’å¯¾è±¡ã¨ã—ãŸé …ç›®ã‚’è¡¨ã—ã¾ã™ã€‚

## å…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã®cookbookã‚’è¦‹ã‚‹[S]

https://github.com/dotnet/roslyn/blob/main/docs/features/source-generators.cookbook.md

ã‚½ãƒ¼ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã ã‘ã§ã™ãŒã€cookbookãŒã‚ã‚‹ã®ã§éå¸¸ã«å½¹ç«‹ã¡ã¾ã™ã€‚

## ãŠã¾ã˜ãªã„ã‚’csprojã«æ›¸ã[A/S]

ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ãƒ»ã‚½ãƒ¼ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã¯csprojã«ã„ã‚ã„ã‚ãªãŠã¾ã˜ãªã„ãŒå¿…è¦ã§ã™ã€‚

### NuGet ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œã‚‹

ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ãƒ»ã‚½ãƒ¼ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã¯æ™®æ®µã¨ç•°ãªã‚‹æ‰‹é †ã§NuGet ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€ã„ã‚ã„ã‚ã¨ãŠã¾ã˜ãªã„ãŒã‚ã‚Šã¾ã™ã€‚

```xml
<PropertyGroup>
  <IncludeBuildOutput>false</IncludeBuildOutput>
  <IncludeSymbols>false</IncludeSymbols>
 <TargetsForTfmSpecificContentInPackage>$(TargetsForTfmSpecificContentInPackage);PackBuildOutputs</TargetsForTfmSpecificContentInPackage>
  <SuppressDependenciesWhenPacking>true</SuppressDependenciesWhenPacking>
  <DevelopmentDependency>true</DevelopmentDependency>
</PropertyGroup>

<ItemGroup>
  <PackageReference Include="Microsoft.CodeAnalysis.Analyzers" Version="3.3.2">
    <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
    <PrivateAssets>all</PrivateAssets>
  </PackageReference>
  <PackageReference Include="Microsoft.CodeAnalysis.CSharp" Version="3.9.0" />
</ItemGroup>


<Target Name="GetDependencyTargetPaths">
<ItemGroup>
    <TargetPathWithTargetPlatformMoniker Include="$(PkgNewtonsoft_Json)\lib\netstandard2.0\*.dll" IncludeRuntimeDependency="false" />
</ItemGroup>
</Target>

<Target Name="PackBuildOutputs" DependsOnTargets="SatelliteDllsProjectOutputGroup;DebugSymbolsProjectOutputGroup">
<ItemGroup>
    <TfmSpecificPackageFile Include="$(TargetDir)\*.dll" PackagePath="analyzers\dotnet\cs" />
    <TfmSpecificPackageFile Include="$(PkgNewtonsoft_Json)\lib\netstandard2.0\*.dll" PackagePath="analyzers\dotnet\cs" />
    <TfmSpecificPackageFile Include="@(SatelliteDllsProjectOutputGroupOutput->'%(FinalOutputPath)')" PackagePath="analyzers\dotnet\cs\%(SatelliteDllsProjectOutputGroupOutput.Culture)\" />
</ItemGroup>
</Target>
```


|è¨­å®š|èª¬æ˜|
|----|----|
|IncludeBuildOutput=false|ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«DLLã‚’è‡ªå‹•è¿½åŠ ã—ãªã„|
|IncludeSymbols=false|ã‚·ãƒ³ãƒœãƒ«æƒ…å ±ã¯ä¸è¦|
|TargetsForTfmSpecificContentInPackage|ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ§‹æˆè¨­å®š|
|SuppressDependenciesWhenPacking=true|ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä¾å­˜é–¢ä¿‚ã‚’å«ã‚ãªã„|
|DevelopmentDependency=true|ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã¨ã—ã¦æ‰±ã†|

`DevelopmentDependency`ã‚’`true`ã«è¨­å®šã™ã‚‹ã¨ã€NuGetä¸Šã§ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã®ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹éš›ã«ã‚‚è‡ªå‹•ã§ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ç”¨ã®è¨­å®šã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚

```xml
<PackageReference Include="SourceExpander.Embedder" Version="3.0.0">
  <PrivateAssets>all</PrivateAssets>
  <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
</PackageReference>
```

`DevelopmentDependency`ãŒ`true`ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã€ä¸Šè¨˜ã®ã‚ˆã†ã«`PrivateAssets`, `IncludeAssets`ãŒè‡ªå‹•ã§è¨­å®šã•ã‚Œã¾ã™ã€‚

ã“ã‚Œã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã®ä¾å­˜ãŒæ¼ã‚Œãªããªã‚Šã¾ã™ã€‚

### Newtonsoft.Jsonã‚’ä½¿ç”¨ã™ã‚‹

ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ãƒ»ã‚½ãƒ¼ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ä½¿ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯NuGetã§ã®ä¾å­˜é–¢ä¿‚ã‚’è§£æ±ºã—ã¾ã›ã‚“ã€‚

ãã®ãŸã‚ã€DLLã‚’åŸ‹ã‚è¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

|è¨­å®š|èª¬æ˜|
|----|----|
|GetTargetPathDependsOn|ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è§£æ±º|


`GeneratePathProperty`ã‚’`true`ã«ã™ã‚‹ã¨ã€`Newtonsoft.Json`ãªã‚‰ã°`$(PkgNewtonsoft_Json)`ã¨ã„ã†ã‚ˆã†ãªå¤‰æ•°åã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ãƒ‘ã‚¹ãŒå–å¾—ã§ãã‚‹ã®ã§ã€ã“ã‚Œã‚‚nupkgã«åŸ‹ã‚è¾¼ã¿ã¾ã™ã€‚

Newtonsoft.Jsonã¯MITãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãªã®ã§ãã¡ã‚“ã¨è¡¨è¨˜ã‚‚ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```xml
<PropertyGroup>
  <IncludeBuildOutput>false</IncludeBuildOutput>
  <IncludeSymbols>false</IncludeSymbols>
  <TargetsForTfmSpecificContentInPackage>$(TargetsForTfmSpecificContentInPackage);PackBuildOutputs</TargetsForTfmSpecificContentInPackage>
  <GetTargetPathDependsOn>$(GetTargetPathDependsOn);GetDependencyTargetPaths</GetTargetPathDependsOn>
  <SuppressDependenciesWhenPacking>true</SuppressDependenciesWhenPacking>
  <DevelopmentDependency>true</DevelopmentDependency>
</PropertyGroup>

<ItemGroup>
  <PackageReference Include="Newtonsoft.Json" Version="12.0.3" GeneratePathProperty="true" />
  <PackageReference Include="Microsoft.CodeAnalysis.Analyzers" Version="3.3.2">
    <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
    <PrivateAssets>all</PrivateAssets>
  </PackageReference>
  <PackageReference Include="Microsoft.CodeAnalysis.CSharp" Version="3.9.0" />
</ItemGroup>

<Target Name="GetDependencyTargetPaths">
<ItemGroup>
    <TargetPathWithTargetPlatformMoniker Include="$(PkgNewtonsoft_Json)\lib\netstandard2.0\*.dll" IncludeRuntimeDependency="false" />
</ItemGroup>
</Target>

<Target Name="PackBuildOutputs" DependsOnTargets="SatelliteDllsProjectOutputGroup;DebugSymbolsProjectOutputGroup">
<ItemGroup>
    <TfmSpecificPackageFile Include="$(TargetDir)\*.dll" PackagePath="analyzers\dotnet\cs" />
    <TfmSpecificPackageFile Include="$(PkgNewtonsoft_Json)\lib\netstandard2.0\*.dll" PackagePath="analyzers\dotnet\cs" />
    <TfmSpecificPackageFile Include="@(SatelliteDllsProjectOutputGroupOutput->'%(FinalOutputPath)')" PackagePath="analyzers\dotnet\cs\%(SatelliteDllsProjectOutputGroupOutput.Culture)\" />
</ItemGroup>
</Target>
```

## ã“ã¾ã‚ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹[A/S]

`SyntaxNodeAnalysisContext`ã‚„`GeneratorExecutionContext`ãªã©ã«ã¯`System.Threading.CancellationToken`ãŒæ¸¡ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã¾ã‚ã«`context.CancellationToken.ThrowIfCancellationRequested()`ã‚’å®Ÿè¡Œã—ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ãƒã‚§ãƒƒã‚¯ã‚’ã—ã¾ã—ã‚‡ã†ã€‚

Visual Studioã§ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ãƒ»ã‚½ãƒ¼ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã®ã§é »ç¹ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã™ã€‚ã—ã‹ã—ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒã‚§ãƒƒã‚¯ã‚’ã—ã¦ã„ãªã„ã¨ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ãƒ»ã‚½ãƒ¼ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å®Ÿè¡ŒãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…ã¤ã“ã¨ã«ãªã‚Šã€ãƒ•ãƒªãƒ¼ã‚ºã—ãŸã‚Šã—ã¾ã™ã€‚

## Diagnosticã®å‡ºåŠ›[A/S]

ã“ã‚Œã«ã¤ã„ã¦ã¯å¥½ã¿ãŒåˆ†ã‹ã‚Œã‚‹ã‹ã¨æ€ã„ã¾ã™ãŒã€`DiagnosticDescriptor` ã‹ã‚‰ `Diagnostic` ã‚’ä½œã‚‹ã®ã¯`DiagnosticDescriptor`ã”ã¨ã«ãƒ¡ã‚½ãƒƒãƒ‰åŒ–ã—ã¦ã—ã¾ã£ã¦è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ¸¡ã™å¼•æ•°ã®æ•°ã¯å›ºå®šã«ã—ãŸã„ã¯ãšãªã®ã§ã€`Diagnostic.Create`ã§ä½œã‚‹ç®‡æ‰€ã¯éš è”½ã—ã¦ã—ã¾ã„ã¾ã—ã‚‡ã†ã€‚

ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã ã¨`DiagnosticDescriptor`ã‚’æ¸¡ã™å¿…è¦ãŒã‚ã‚‹éƒ½åˆä¸Šã€`private`ã«ã¯ã§ãã¾ã›ã‚“ãŒã€ãã‚Œä»¥å¤–ã§ã¯ä½¿ã‚ãªã„ã»ã†ãŒè‰¯ã„ã‹ã¨æ€ã„ã¾ã™ã€‚

```csharp
public static Diagnostic EMBED0001_UnknownError(string message)
    => Diagnostic.Create(EMBED0001_UnknownError_Descriptor, Location.None, message);
private static readonly DiagnosticDescriptor EMBED0001_UnknownError_Descriptor = new(
    "EMBED0001",
    new LocalizableResourceString(
        nameof(DiagnosticsResources.EMBED0001_Title),
        DiagnosticsResources.ResourceManager,
        typeof(DiagnosticsResources)),
    new LocalizableResourceString(
        nameof(DiagnosticsResources.EMBED0001_Body),
        DiagnosticsResources.ResourceManager,
        typeof(DiagnosticsResources)),
    "Error",
    DiagnosticSeverity.Warning,
    true);
```

## ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰å®Ÿè¡Œ[A/S]

`compilation.Options.ConcurrentBuild` ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã‚’å–å¾—ã§ãã¾ã™ã€‚

ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ãªã¨ãã¯ä¸¦åˆ—å®Ÿè¡Œã‚‚æ´»ç”¨ã—ã¦é«˜é€Ÿã«å‹•ä½œã•ã›ãŸã„ã§ã™ã­ã€‚

```csharp
SyntaxTree[] newTrees;
if (compilation.Options.ConcurrentBuild)
    newTrees = compilation.SyntaxTrees.AsParallel().WithCancellation(cancellationToken)
        .Select(Rewrited).ToArray();
else
    newTrees = compilation.SyntaxTrees
        .Select(Rewrited).ToArray();
```

ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã®å ´åˆã¯ `AnalysisContext`ã§`context.EnableConcurrentExecution()`ã‚’å®Ÿè¡Œã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚