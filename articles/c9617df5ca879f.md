---
title: "[C#]WPFã§ã®MVVMã«ã¤ã„ã¦ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‹ã‚‰ã¾ã¨ã‚"
emoji: "ğŸ“¥"
type: "tech"
topics:
  - "csharp"
  - "mvvm"
  - "wpf"
published: true
published_at: "2022-08-31 19:27"
---

# WPF ã§ã® MVVM

Model/View/ViewModel ã®è©±ãªã©ã‚ã‚Šã¾ã™ãŒã€ãã¡ã‚“ã¨ç†è§£ã™ã‚‹ã®ã«æ•°å¹´ã‚’è¦ã—ãŸæ¦‚å¿µãªã®ã§æ”¹ã‚ã¦æ¦‚å¿µã‚’ã¾ã¨ã‚ã¦ã¿ã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¾ã¨ã‚ãŸã„ã“ã¨
- Model/View/ViewModel ã®æ›¸ãæ–¹
- View ã¨ ViewModel ã®åˆ†é›¢ã«ã¤ã„ã¦
  - ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å‡ºã—æ–¹

[.NET Community Toolkit](https://github.com/CommunityToolkit/dotnet), Microsoft.Extensions.DependencyInjection, [Microsoft.Xaml.Behaviors.Wpf](https://github.com/microsoft/XamlBehaviorsWpf) ã®ä½¿ç”¨ã‚’å‰æã¨ã—ã¾ã™ã€‚

ä½œã£ãŸã‚¢ãƒ—ãƒªã®ã‚µãƒ³ãƒ—ãƒ«ã¯

https://github.com/kzrnm/MvvmSample

ã«è¨­ç½®ã—ã¾ã™ã€‚

## ä½œã‚‹ã‚¢ãƒ—ãƒª
ãƒ»Web APIã‹ã‚‰ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—ã—ã¦ã€ãã®çµæœã‚’è¡¨ç¤º
ãƒ»ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ç¢ºèªå¾Œã€é¸æŠå†…å®¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹

## MVVM ã®å®Ÿè£…

### Model

MVVM ã«ãŠã‘ã‚‹ Model ã¯ã€ŒView ã«é–¢ã‚ã‚‰ãªã„ã“ã¨å…¨èˆ¬ã€ã§ã™ã€‚
APIã®ã‚¢ã‚¯ã‚»ã‚¹ã ã£ãŸã‚Šã€OSã¨ã®ã‚„ã‚Šã¨ã‚Šã ã£ãŸã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒã ã£ãŸã‚Šã®å…¨èˆ¬ã‚’è¡Œã„ã¾ã™ã€‚

ã“ã“ã§ã¯ã€Web ã‹ã‚‰ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—ã™ã‚‹ `WebTimeService` ã‚’ä½œæˆã—ã¾ã™ã€‚`GetTimeAsync()` ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ `IWebTimeService` ã¨ã—ã¦ã‚‚å‘¼ã¹ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚
ãªãœã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã«ã™ã‚‹ã‹ã¯å¾Œè¿°ã€‚

```csharp
public interface IWebTimeService
{
    Task<WorldClock> GetTimeAsync();
}
public class WebTimeService : IWebTimeService
{
    private readonly HttpClient http;
    public WebTimeService(HttpClient http)
    {
        this.http = http;
    }
    public async Task<WorldClock> GetTimeAsync()
    {
        // {
        //     "$id": "1",
        //     "currentDateTime": "2021-12-13T15:30Z",
        //     "utcOffset": "00:00:00",
        //     "isDayLightSavingsTime": false,
        //     "dayOfTheWeek": "Monday",
        //     "timeZoneName": "UTC",
        //     "currentFileTime": 132838830284824910,
        //     "ordinalDate": "2021-347",
        //     "serviceResponse": null
        // }
        var url = "http://worldclockapi.com/api/json/utc/now";
        var response = await http.GetAsync(url).ConfigureAwait(false);
        using var stream = await response.Content.ReadAsStreamAsync();
        return await System.Text.Json.JsonSerializer.DeserializeAsync<WorldClock>(stream).ConfigureAwait(false);
    }
}
```

ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã¤ã„ã¦ã‚‚åŒæ§˜ã€‚

```csharp
public interface IClipboardService
{
    void SetText(string text);
}
public class ClipboardService : IClipboardService
{
    public void SetText(string text)
    {
        Clipboard.SetText(text);
    }
}
```

### View model

View model ã¯ 
- View ã¨ã®ãƒ‡ãƒ¼ã‚¿ã®ã‚„ã‚Šã¨ã‚Š
- View ã¨ã®ã‚³ãƒãƒ³ãƒ‰ã®ã‚„ã‚Šã¨ã‚Š
  - API å‘¼ã³å‡ºã—ãªã©ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ Model ã«ä»»ã›ã‚‹

ãŒå½¹å‰²ã§ã™ã€‚

ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ»ã‚³ãƒãƒ³ãƒ‰ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã ã‘ãŒä¸¦ã¶ã‚¯ãƒ©ã‚¹ã«ãªã‚‹ã®ãŒç†æƒ³ã§ã™ã€‚

View ã¨ãƒ‡ãƒ¼ã‚¿ã®ã‚„ã‚Šã¨ã‚Šã‚’ã™ã‚‹ãŸã‚ã« `INotifyPropertyChanged` ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

Community Toolkit ã§ã¯ `CommunityToolkit.Mvvm.ComponentModel.ObservableObject` ã§å®Ÿè£…æ¸ˆã¿ã§ã™ã®ã§ã€ãã‚Œã‚’ä½¿ã„ã¾ã™ã€‚

`IWebTimeService`, `IClipboardService` ã¯ Community Toolkit ã® DI(Dependency Injection) ã§è§£æ±ºã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

```csharp
public partial class MainWindowViewModel : ObservableObject
{
    public MainWindowViewModel(IWebTimeService gitHubService, IClipboardService clipboardService)
    {
        WebTimeService = gitHubService;
        ClipboardService = clipboardService;
    }

    private IWebTimeService WebTimeService { get; }
    private IClipboardService ClipboardService { get; }

    [ObservableProperty]
    private WorldClock? _CurrentDateTime;
    // [ObservableProperty] ãŒã¤ã„ã¦ã„ã‚‹ã¨ â†“ ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒ CommunityToolkit ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹
    // public WorldClock? CurrentDateTime
    // {
    //    set
    //    {
    //         if (!System.Collections.Generic.EqualityComparer<DateTime>.Default.Equals(_CurrentDateTime, value))
    //         {
    //             _CurrentDateTime = value;
    //             PropertyChanged?.Invoke(new PropertyChangedEventArgs("CurrentDateTime"));
    //         }
    //    }
    //    get => _CurrentDateTime;
    // }

    [RelayCommand]
    private async Task GetDateTime()
    {
        CurrentDateTime = await WebTimeService.GetTimeAsync();
    }

    [RelayCommand]
    private void CopyCurrentDateTime()
    {
        var dialogResult = WeakReferenceMessenger.Default.Send(new DialogMessage
        {
            Caption = "ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼",
            Text = "ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã‹ï¼Ÿ",
            MessageBoxButton = System.Windows.MessageBoxButton.YesNo,
            MessageBoxImage = System.Windows.MessageBoxImage.Question,
        });
        if (dialogResult.HasReceivedResponse
                && dialogResult.Response == System.Windows.MessageBoxResult.Yes
                && CurrentDateTime?.DateTime is { } time)
        {
            ClipboardService.SetText(time.ToString());
        }
    }
}
```

ViewModel ã§ `MessageBox.Show` ã—ã¦ã—ã¾ã†ã¨ã€Viewã¨ViewModelã®åˆ†é›¢ãŒã§ããªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚åˆ†é›¢ã§ãã‚‹ã‚ˆã† `DialogMessage` ã‚’ Behavior ã«é€ã‚Šã¤ã‘ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
Behavior ã®å®Ÿè£…ã¯ GitHub å‚ç…§ã€‚
https://github.com/kzrnm/MvvmSample/tree/HEAD/MvvmSample-Wpf/Behaviors

ãªãœViewã¨ViewModelã‚’åˆ†é›¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã¯å¾Œè¿°ã€‚

### View

View ã¯æ™®é€šã« xaml ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ›¸ãã¾ã™ã€‚
- `DataContext` ã‚’ ViewModel ã§åˆæœŸåŒ–ã™ã‚‹ãŸã‚ã«ã‚³ãƒ¼ãƒ‰ãƒ“ãƒã‚¤ãƒ³ãƒ‰ãŒå¿…è¦ã€‚ãŸã ã—ã€æ·»ä»˜ãƒ“ãƒ˜ã‚¤ãƒ“ã‚¢ã‚’ä½¿ã£ã¦xamlå´ã§æ›¸ãã“ã¨ã‚‚å¯èƒ½ã§ã™(å¾Œè¿°)
- ViewModel ã§ `DialogMessage` ã‚’é€ã£ã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚’å—ã‘å–ã‚‹ `DialogBehavior` ã‚’è¨­å®šã—ã¦ãŠãã€‚

```xml
<Window x:Class="Kzrnm.MvvmSample.Wpf.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:Behaviors="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:localbehavior="clr-namespace:Kzrnm.MvvmSample.Wpf.Behaviors"
        xmlns:vm="clr-namespace:Kzrnm.MvvmSample.Wpf.ViewModels"
        d:DataContext="{d:DesignInstance vm:MainWindowViewModel}"
        mc:Ignorable="d"
        Title="MainWindow" Height="450" Width="800">
    <Behaviors:Interaction.Behaviors>
        <localbehavior:DialogBehavior />
    </Behaviors:Interaction.Behaviors>
    <StackPanel>
        <TextBlock Text="CurrentUserUrl"/>
        <StackPanel Orientation="Horizontal">
            <TextBlock Text="Timezone: "/>
            <TextBlock Text="{Binding CurrentDateTime.TimeZoneName}" />
        </StackPanel>
        <TextBox IsReadOnly="True" Text="{Binding CurrentDateTime.DateTime}" />
        <Button Content="APIå‘¼ã³å‡ºã—" Command="{Binding GetDateTimeCommand, Mode=OneTime}" />
        <Button Content="ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼" Command="{Binding CopyCurrentDateTimeCommand, Mode=OneTime}" />
    </StackPanel>
</Window>
```

```csharp
public MainWindow()
{
    InitializeComponent();
    DataContext = Ioc.Default.GetService<MainWindowViewModel>();
}
```

### Application ã®åˆæœŸåŒ–

Community Toolkit ã® DI ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã€`Application` ã®åˆæœŸåŒ–æ™‚ã« DI ã®åˆæœŸåŒ–ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä½¿ã£ã¦ã„ã‚‹å‹ã‚’åˆ—æŒ™ã™ã‚‹ã ã‘ã§ã™ã€‚

```csharp
public partial class App : Application
{
    public App()
    {
        Ioc.Default.ConfigureServices(
            new ServiceCollection()
            .AddSingleton<HttpClient>()
            .AddSingleton<IClipboardService, ClipboardService>()
            .AddSingleton<IWebTimeService, WebTimeService>()
            .AddTransient<MainWindowViewModel>()
            .BuildServiceProvider());
    }
}
```

![ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã„ã¦ã„ã‚‹ã‚¢ãƒ—ãƒª](https://storage.googleapis.com/zenn-user-upload/11ce019111d4-20220831.png)

#### éåŒæœŸãªåˆæœŸåŒ–ã®å ´åˆ

éåŒæœŸãªåˆæœŸåŒ–ã ã¨ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ã¯ã§ãã¾ã›ã‚“ã€‚

`App.xaml` ã® `StartupUri="Views/MainWindow.xaml"` ã‚’å‰Šé™¤ã—ã¦æ‰‹å‹•ã§ MainWindow ã‚’èµ·å‹•ã—ã¦ã‚ã’ã¾ã—ã‚‡ã†ã€‚

```csharp
public partial class App : Application
{
    protected override async void OnStartup(StartupEventArgs e)
    {
        var fooResult = await ãªã‚“ã‹ã®ãƒ¡ã‚½ãƒƒãƒ‰();
        Ioc.Default.ConfigureServices(
            new ServiceCollection()
            .AddSingleton(fooResult)
            .AddSingleton<HttpClient>()
            .AddSingleton<HttpClient>()
            .AddSingleton<IClipboardService, ClipboardService>()
            .AddSingleton<IWebTimeService, WebTimeService>()
            .AddTransient<MainWindowViewModel>()
            .BuildServiceProvider());
        new MainWindow().Show();
        base.OnStartup(e);
    }
}
```


## è¿½åŠ æ¤œè¨(MVVM ã®åˆ©ç‚¹/ã‚³ãƒ¼ãƒ‰ã®æ”¹å–„)
ã€Œå¾Œè¿°ã€ã¨ã—ã¦ããŸå†…å®¹ã«ã¤ã„ã¦è€ƒãˆã¦ã„ãã¾ã™ã€‚

### Service ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹åŒ–ã™ã‚‹ç†ç”±

[Moq](https://github.com/moq/moq4) ã® `Mock` å‹ã§ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒ“ã‚¹ã‚’å…¥ã‚Œã¦ ViewModel ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã§APIå‘¼ã³å‡ºã—ãªã©ã™ã‚‹ã®ã¯é¿ã‘ãŸã„ã®ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®æ–¹ãŒéƒ½åˆãŒè‰¯ã„ã§ã™ã€‚

```csharp
[Fact]
public async Task GetDateTime()
{
    var webTimeServiceMock = new Mock<IWebTimeService>();
    var clipboardServiceMock = new Mock<IClipboardService>();

    webTimeServiceMock.Setup(s => s.GetTimeAsync())
        .ReturnsAsync(new Models.WorldClock
        {
            TimeZoneName = "UTC",
            CurrentFileTime = 133000000000000000,
        });

    var viewModel = new MainWindowViewModel(webTimeServiceMock.Object, clipboardServiceMock.Object);
    Assert.Null(viewModel.CurrentDateTime);
    await viewModel.GetDateTimeCommand.ExecuteAsync(null);
    Assert.NotNull(viewModel.CurrentDateTime);
    Assert.Equal(133000000000000000, viewModel.CurrentDateTime.CurrentFileTime);
}
```

### Viewã¨ViewModelã®åˆ†é›¢ãŒå¿…è¦ãªç†ç”±

ã“ã¡ã‚‰ã‚‚ ViewModel ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã§é‡è¦ã§ã™ã€‚
`MessageBox.Show` ãŒå­˜åœ¨ã™ã‚‹ã¨ UI ã§ã®å®Ÿè¡ŒãŒçµ¡ã‚“ã§ãã‚‹ã®ã§ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒå‡ºæ¥ã¾ã›ã‚“ã€‚

```csharp
WeakReferenceMessenger.Default.Register<DialogMessage>(recipient, (_, message) =>
            {
                message.Reply(System.Windows.MessageBoxResult.Yes);
            });
```

ã¨ã„ã†ã‚ˆã†ã« `MessageBox.Show` ã®ä»£ã‚ã‚Šã«å›ºå®šå€¤ã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚Œã° `MessageBox` ã®çµæœã”ã¨ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

```csharp
readonly object recipient = new object();
[Fact]
public void DialogYes()
{
    var webTimeServiceMock = new Mock<IWebTimeService>();
    var clipboardServiceMock = new Mock<IClipboardService>();

    lock (recipient)
    {
        try
        {
            WeakReferenceMessenger.Default.Register<DialogMessage>(recipient, (_, message) =>
            {
                message.Reply(System.Windows.MessageBoxResult.Yes);
            });
            var viewModel = new MainWindowViewModel(webTimeServiceMock.Object, clipboardServiceMock.Object);
            Assert.Null(viewModel.CurrentDateTime);

            viewModel.CopyCurrentDateTimeCommand.Execute(null);
            clipboardServiceMock.Verify(s => s.SetText(It.IsAny<string>()), Times.Never());


            var clock = new Models.WorldClock
            {
                TimeZoneName = "UTC",
                CurrentFileTime = 133000000000000000,
            };
            viewModel.CurrentDateTime = clock;

            viewModel.CopyCurrentDateTimeCommand.Execute(null);
            clipboardServiceMock.Verify(s => s.SetText(clock.DateTime.ToString()), Times.Once());
        }
        finally
        {
            WeakReferenceMessenger.Default.UnregisterAll(recipient);
        }
    }
}

[Fact]
public void DialogNo()
{
    var webTimeServiceMock = new Mock<IWebTimeService>();
    var clipboardServiceMock = new Mock<IClipboardService>();

    lock (recipient)
    {
        try
        {
            WeakReferenceMessenger.Default.Register<DialogMessage>(recipient, (_, message) =>
            {
                message.Reply(System.Windows.MessageBoxResult.No);
            });
            var viewModel = new MainWindowViewModel(webTimeServiceMock.Object, clipboardServiceMock.Object);
            Assert.Null(viewModel.CurrentDateTime);

            viewModel.CopyCurrentDateTimeCommand.Execute(null);
            clipboardServiceMock.Verify(s => s.SetText(It.IsAny<string>()), Times.Never());

            var clock = new Models.WorldClock
            {
                TimeZoneName = "UTC",
                CurrentFileTime = 133000000000000000,
            };
            viewModel.CurrentDateTime = clock;

            viewModel.CopyCurrentDateTimeCommand.Execute(null);
            clipboardServiceMock.Verify(s => s.SetText(It.IsAny<string>()), Times.Never());
        }
        finally
        {
            WeakReferenceMessenger.Default.UnregisterAll(recipient);
        }
    }
}
```

### æ·»ä»˜ãƒ“ãƒ˜ã‚¤ãƒ“ã‚¢ã§ DataContext ã‚’åˆæœŸåŒ–

æ·»ä»˜ãƒ“ãƒ˜ã‚¤ãƒ“ã‚¢ã§è‡ªå‹•åˆæœŸåŒ–ã™ã‚‹ã¨ã‚³ãƒ¼ãƒ‰ãƒ“ãƒã‚¤ãƒ³ãƒ‰ä¸è¦ã«ãªã‚Šã¾ã™ã€‚

```csharp
public class Ioc
{
    public static CommunityToolkit.Mvvm.DependencyInjection.Ioc DefaultIoc { set; get; } = CommunityToolkit.Mvvm.DependencyInjection.Ioc.Default;
    public static Type GetAutoViewModel(DependencyObject obj) => (Type)obj.GetValue(AutoViewModelProperty);
    public static void SetAutoViewModel(DependencyObject obj, Type value) => obj.SetValue(AutoViewModelProperty, value);
    public static readonly DependencyProperty AutoViewModelProperty =
        DependencyProperty.RegisterAttached(
            "AutoViewModel",
            typeof(Type),
            typeof(Ioc),
            new FrameworkPropertyMetadata(null,
                FrameworkPropertyMetadataOptions.NotDataBindable,
                AutoViewModelChanged));

    private static void AutoViewModelChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
    {
        if (DesignerProperties.GetIsInDesignMode(d))
            return;
        if (d is FrameworkElement elm && e.NewValue is Type type)
            elm.DataContext = DefaultIoc.GetService(type);
    }
}
```

```xml
<Window x:Class="Kzrnm.MvvmSample.Wpf.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:Behaviors="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:localbehavior="clr-namespace:Kzrnm.MvvmSample.Wpf.Behaviors"
        xmlns:vm="clr-namespace:Kzrnm.MvvmSample.Wpf.ViewModels"
        d:DataContext="{d:DesignInstance vm:MainWindowViewModel}"
        localbehavior:Ioc.AutoViewModel="{x:Type vm:MainWindowViewModel}"
        mc:Ignorable="d"
        Title="MainWindow" Height="450" Width="800">
```

```csharp
public MainWindow()
{
    InitializeComponent();
}
```