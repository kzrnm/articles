---
title: "ã€C#ã€‘ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæœ"
emoji: "ğŸ”¬"
type: "tech"
topics:
  - "csharp"
published: true
published_at: "2021-12-11 16:41"
---

# ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

C# ã¯é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã®ã‚ˆã†ãªæ©Ÿèƒ½ã¨ã—ã¦ delegate ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚

:::message
æ³¨:
ã“ã“ã§ã„ã†ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã¯

```cs
delegate TResult Func<T1, TResult>(T1 a);
```

ã¨ã„ã†ã‚ˆã†ãªå‹å®šç¾©ã®è©±ã§ã™ã€‚

C# 2.0 ã®æ™‚ä»£ã®

```cs
delegate(int num){ return num; }
```

ã¨ã„ã†ã‚ˆã†ãªåŒ¿åãƒ¡ã‚½ãƒƒãƒ‰ã®è©±ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
:::


ãã®å†…å®¹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

C# ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæœã® IL ã‚„ãã‚Œã‚’ C# ã«ãƒ‡ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ãŸçµæœã‚’è¦‹ã‚‰ã‚Œã‚‹ SharpLab ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚’å…ƒã«ã—ã¦ã„ã¾ã™ã€‚
2021å¹´12æœˆæ™‚ç‚¹ã® Roslyn ã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæœã§ã™ã€‚
https://sharplab.io/

ä¸‹è¨˜ã® `Do` ãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã‚’æ›¸ãæ›ãˆãŸã¨ãã®æ¯”è¼ƒã‚’ã—ã¦ã¿ã¾ã™ã€‚

```cs
using System;
public class C {
    public int Do(Func<int,int> func) => func(0);
    
    public void M()
    {
        Do(/* ã“ã“ã‚’æ›¸ãæ›ãˆã‚‹ */);
    }
}
```

ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæœã® IL ã«ã¯ `<>c` ã¨ã„ã£ãŸã‚ˆã†ãªã‚¯ãƒ©ã‚¹åãƒ»ãƒ¡ã‚½ãƒƒãƒ‰åãŒã¤ã„ãŸã‚‚ã®ãŒå‡ºåŠ›ã•ã‚ŒãŸã‚Šã™ã‚‹ã®ã§é©å®œ C# ã§æˆç«‹ã™ã‚‹ã‚ˆã†ãªç­‰ä¾¡ãªã‚³ãƒ¼ãƒ‰ã«ã—ã¾ã™ã€‚

## é™çš„ãƒ¡ã‚½ãƒƒãƒ‰

```cs:å…¥åŠ›
public void M()
{
    Do(Static);
}
// ------
static int Static(int num) => num;
```

```cs:çµæœ
public void M()
{
    Do(new Func<int, int>(Static));
}
static int Static(int num) => num;
```

IL ä¸Šã§ååˆ†è¡¨ç¾ã§ãã‚‹ã®ã§ãã®ã¾ã¾ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«ä»£å…¥ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

## ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰

```cs:å…¥åŠ›
public void M()
{
    Do(this.Instance);
}
// ------
int Instance(int num) => num;
```

```cs:çµæœ
public void M()
{
    Do(new Func<int, int>(Instance));
}
```

IL ä¸Šã§ååˆ†è¡¨ç¾ã§ãã‚‹ã®ã§ãã®ã¾ã¾ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«ä»£å…¥ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

## æ‹¡å¼µãƒ¡ã‚½ãƒƒãƒ‰

```cs:å…¥åŠ›
public void M()
{
    Do(default(object).Ext);
}
// ------
static class Extension
{
    public static int Ext(this object x, int num) => num;    
}
```

```cs:çµæœ
public void M()
{
    Do(new Func<int, int>(null, (nint)(delegate*<object, int, int>)(&Extension.Ext)));
}
```

C# 9.0 ã§å°å…¥ã•ã‚ŒãŸé–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã§ãªã‚“ã ã‹ã‚ˆãã‚ã‹ã‚‰ãªã„ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

ã¡ãªã¿ã«ã€é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã‚’å–ã‚Šå‡ºã—ã¦ã„ã‚‹ã®ã¯ `ldftn` ã¨ã„ã† IL ã®å‘½ä»¤ã§ã™ãŒã€é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ãŒå­˜åœ¨ã—ãªã„ C# 8.0 ä»¥å‰ã ã¨è¡¨ç¾ã§ãã¾ã›ã‚“ã€‚

ã“ã®ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒãªã«ã‹ã¯ ufcpp ã§è§£èª¬ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://ufcpp.net/study/csharp/functional/miscdelegateinternal/

## å¤‰æ•°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãªã„ãƒ©ãƒ ãƒ€å¼

```cs:å…¥åŠ›
public void M()
{
    Do(num => num);
}
```

```cs:çµæœ
public void M()
{
    Do(__c.__c_func ?? (__c.__c_func = new Func<int, int>(__c.__9.M__b)));
}
private sealed class __c
{
    public static readonly __c __9 = new __c();
    public static Func<int, int> __c_func;
    internal int M__b(int num)
    {
        return num;
    }
}
```

ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¯ãƒ©ã‚¹ãŒä½œæˆã•ã‚Œã¦ã€ãã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦ãƒ‡ãƒªã‚²ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã™ã€‚

## ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ãƒ©ãƒ ãƒ€å¼

```cs:å…¥åŠ›
private string Text;
public void M()
{
    Do(num => num + Text.Length);
}
```

```cs:çµæœ
public void M()
{
    Do(new Func<int, int>(M__b));
}
private int M__b(int num)
{
    return num + Text.Length;
}
```

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

## ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ãƒ©ãƒ ãƒ€å¼

```cs:å…¥åŠ›
private string Text;
public void M()
{
    int cap = 2;
    Do(num => num + cap + Text.Length);
}
```

```cs:çµæœ
private sealed class c__DisplayClass
{
    public int cap;

    public C __this;

    internal int b(int num)
    {
        return num + cap + __this.Text.Length;
    }
}

public void M()
{
    var d = new c__DisplayClass();
    d.__this = this;
    d.cap = 2;
    Do(new Func<int, int>(d.b));
}
```

ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã¨ `this` ã‚’ä¿æŒã™ã‚‹ã‚¯ãƒ©ã‚¹ãŒä½œã‚‰ã‚Œã‚‹ãªã©ä¸€æ°—ã«å¤§ã’ã•ã«ãªã£ã¦ãã¾ã—ãŸã€‚
ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã ã¨æ€ã£ãŸã‚‰ã„ã¤ã®ã¾ã«ã‹åˆ¥ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã«ãªã£ã¦ã„ã‚‹ã®ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ°—ã«ã™ã‚‹ã¨ãã¯æ°—ã‚’ã¤ã‘ãŸã»ã†ãŒè‰¯ã•ãã†ã§ã™ã€‚


## å¤‰æ•°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãªã„ãƒ­ãƒ¼ã‚«ãƒ«é–¢æ•°

```cs:å…¥åŠ›
public void M()
{
    static int Local(int num)
    {
        return num;
    }
    Do(Local);
}
```

```cs:çµæœ
public void M()
{
    Do(new Func<int, int>(M__Local));
}
internal static int M__Local(int num)
{
    return num;
}
```

å†…éƒ¨ã§ã¯æ™®é€šã®é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ãŒä½œã‚‰ã‚Œã¾ã™ã€‚

## ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«é–¢æ•°

```cs:å…¥åŠ›
private string Text;
public void M()
{
    int Local(int num)
    {
        return num + Text.Length;
    }
    Do(Local);
}
```

```cs:çµæœ
public void M()
{
    Do(new Func<int, int>(M__Local));
}
private int M__Local(int num)
{
    return num + Text.Length;
}
```

å†…éƒ¨ã§ã¯æ™®é€šã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ãŒä½œã‚‰ã‚Œã¾ã™ã€‚

## ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«é–¢æ•°

```cs:å…¥åŠ›
private string Text;
public void M()
{
    int cap = 2;
    int Local(int num)
    {
        return num + cap + Text.Length;
    }
    Do(Local);
}
```

```cs:çµæœ
private sealed class c__DisplayClass
{
    public int cap;

    public C __this;

    internal int g__Local(int num)
    {
        return num + cap + __this.Text.Length;
    }
}

public void M()
{
    var d = new c__DisplayClass();
    d.__this = this;
    d.cap = 2;
    Do(new Func<int, int>(d.g__Local));
}
```

ãƒ©ãƒ ãƒ€å¼ã¨åŒã˜ã§ã™ã€‚

ã¡ãªã¿ã«ã€ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«é–¢æ•°ã‚’ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã«ã—ãªã„å ´åˆã¯ã‚¯ãƒ©ã‚¹ã§ã¯ãªãæ§‹é€ ä½“ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

```cs:å…¥åŠ›
private string Text;
public void M()
{
    int cap = 2;
    int Local(int num)
    {
        return num + cap + Text.Length;
    }
    Local(7);
}
```

```cs:çµæœ
private struct c__DisplayClass
{
    public int cap;

    public C __this;
}

public void M()
{
    var d = new c__DisplayClass();
    d.__this = this;
    d.cap = 2;
    g__Local(7, ref d);
}
private int g__Local(int num, c__DisplayClass p)
{
    return num + p.cap + Text.Length;
}
```
