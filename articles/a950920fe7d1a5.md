---
title: "[C#]CollectionsMarshal ã®è§£èª¬"
emoji: "ğŸ”¬"
type: "tech"
topics:
  - "dotnet"
  - "csharp"
published: true
published_at: "2022-01-07 21:40"
---

.NET 5 ã§ `System.Runtime.InteropServices.CollectionsMarshal` ã¨ã„ã†ã‚¯ãƒ©ã‚¹ãŒå°å…¥ã•ã‚Œã¾ã—ãŸã€‚

`List<T>` ã‚„ `Dictionary<TKey, TValue>` ã®å°‘ã—ä½ãƒ¬ãƒ™ãƒ«ãªã¨ã“ã‚ã‚’è§¦ã‚‰ã›ã¦ãã‚Œã¾ã™ã€‚

## `List<T>` ç”¨

### `AsSpan`

å°å…¥æ™‚æœŸ: .NET 5

`List<T>` ã®å†…éƒ¨é…åˆ—ã‚’å‚ç…§ã™ã‚‹ `Span<T>` ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚

`List<T>.Add` ã®å‰å¾Œã§ä½¿ã£ãŸã‚Šã™ã‚‹ã¨å±ã†ã„ã®ã§ã€ä¸€æ™‚çš„ãªç”¨é€”ã«é™å®šã—ã¦ä½¿ã„ã¾ã—ã‚‡ã†ã€‚

```cs
using System.Runtime.InteropServices;

var list = Enumerable.Range(0, 10).ToList();
var span = CollectionsMarshal.AsSpan(list);
span[^1] = -1;
Console.WriteLine(string.Join(", ", list));
// 0, 1, 2, 3, 4, 5, 6, 7, 8, -1

list.Add(100); // å†…éƒ¨é…åˆ—ãŒå†ç¢ºä¿ã•ã‚Œã‚‹
span[0] = -2;  // ã“ã® span ã¯ list ã®å†…éƒ¨é…åˆ—ã®å‚ç…§ã§ã¯ãªããªã£ã¦ã„ã‚‹
Console.WriteLine(string.Join(", ", list));
// 0, 1, 2, 3, 4, 5, 6, 7, 8, -1, 100
```

## `Dictionary<TKey, TValue>` ç”¨

### `GetValueRefOrAddDefault`

å°å…¥æ™‚æœŸ: .NET 6

`Dictionary<TKey, TValue>`ã‹ã‚‰å‚ç…§ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚å­˜åœ¨ã—ãªã„ã‚­ãƒ¼ã‚’æŒ‡å®šã—ãŸå ´åˆã¯ `default` ã§åˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚

ãƒ¡ã‚½ãƒƒãƒ‰ã®æˆ»ã‚Šå€¤ã§å€¤ã¸ã®å‚ç…§ã‚’è¿”ã—ã€ã‚­ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’ `out` å¼•æ•°ã§è¿”ã—ã¾ã™ã€‚

å€¤ã®å‚ç…§ã‚’è¿”ã™éƒ½åˆã§ã€`Dictionary<TKey, TValue>.TryGetValue` ã§ã¯ã‚­ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’ãƒ¡ã‚½ãƒƒãƒ‰ã®æˆ»ã‚Šå€¤ã§è¿”ã—ã€å€¤ã¯ `out` å¼•æ•°ã§è¿”ã™ä»•æ§˜ã¨ç•°ãªã‚‹ã®ã«æ³¨æ„ã€‚

ã“ã¡ã‚‰ã‚‚å€¤ã‚’è¿½åŠ ã™ã‚‹å‰å¾Œã§ä½¿ã£ãŸã‚Šã™ã‚‹ã¨å±ã†ã„ã®ã§ã€ä¸€æ™‚çš„ãªç”¨é€”ã«é™å®šã—ã¦ä½¿ã„ã¾ã—ã‚‡ã†ã€‚

```cs
using System.Runtime.InteropServices;

var dic = new Dictionary<string, int> {
    { "foo", 1 },
};
bool exists;
ref var foo = ref CollectionsMarshal.GetValueRefOrAddDefault(dic, "foo", out exists);
System.Diagnostics.Debug.Assert(exists);
ref var bar = ref CollectionsMarshal.GetValueRefOrAddDefault(dic, "bar", out exists);
System.Diagnostics.Debug.Assert(!exists);

foo++;
bar++;
Console.WriteLine(string.Join(", ", dic));
// [foo, 2], [bar, 1]

dic.Add("baz", -1);
foo++;
Console.WriteLine(dic["foo"]);
// 3

dic.Add("foobar", -1); // ã“ã“ã§å†ç¢ºä¿ã•ã‚Œã‚‹
foo++; // foo ã¯ dic ã®å†…éƒ¨ã®å‚ç…§ã§ã¯ãªã„
Console.WriteLine(dic["foo"]);
// 3
```

### `GetValueRefOrNullRef`

å°å…¥æ™‚æœŸ: .NET 6

`Dictionary<TKey, TValue>`ã‹ã‚‰å‚ç…§ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚å­˜åœ¨ã—ãªã„ã‚­ãƒ¼ã‚’æŒ‡å®šã—ãŸå ´åˆã¯ null å‚ç…§ã«ãªã‚Šã¾ã™ã€‚

null å‚ç…§ã«è§¦ã‚Œã‚‹ã¨ä¾‹å¤–ãŒæŠ•ã’ã‚‰ã‚Œã‚‹ã®ã§ã€`Unsafe.IsNullRef` ã‚’ä½¿ã£ã¦ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚ã’ã¾ã—ã‚‡ã†ã€‚

```cs
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;

var dic = new Dictionary<string, int> {
    { "foo", 1 },
};
ref var foo = ref CollectionsMarshal.GetValueRefOrNullRef(dic, "foo");
System.Diagnostics.Debug.Assert(!Unsafe.IsNullRef(ref foo));
ref var bar = ref CollectionsMarshal.GetValueRefOrNullRef(dic, "bar");
System.Diagnostics.Debug.Assert(Unsafe.IsNullRef(ref bar));

foo++;
Console.WriteLine(string.Join(", ", dic));
// [foo, 2]

try
{
    bar++;
}
catch (NullReferenceException e)
{
    Console.WriteLine(e.Message);
    // Object reference not set to an instance of an object.
}
```

